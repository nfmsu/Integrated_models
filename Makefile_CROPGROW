# Purpose: 
#	Compiles SWAT with gfortran
# 
# Author: Andre Dozier and Olaf David
#   Date: May 10, 2013 
# 
# 
.SUFFIXES: 
.SUFFIXES: .f .f90 .f03 .o .mod .for .for.in

SYS := $(shell gcc -dumpmachine) 
ifneq (, $(findstring mingw, $(SYS)))
OS := win
endif

# if not release, set the debug flag
ifneq ($(rel),true)
deb := -g
endif

ifeq ($(OS),win)

# windows 
RM = del /F
SWAT.OUT = swat.exe
SWAT.DLL = libswat.dll
EVENT.DIR = ..\event\\
EVENT.DLL = libevent.dll
LIB.DIR = ..\..\lib\\
BIN.DIR = ..\..\bin\\
FFLAGS = -fno-underscoring $(deb)
CP = copy /y

else

# linux 
RM = rm -f
SWAT.OUT = swat
SWAT.DLL = libswat.so
EVENT.DIR := ../event/
LIB.DIR = lib/
BIN.DIR = bin/
EVENT.DLL = libevent.so
FFLAGS = -fno-underscoring -fPIC $(deb)
CP = cp -f 

endif
smrt=SMRT
MODFLOW=MODFLOW
rt=RT3D
swat=SWAT
plant=PLANT
utils1=UTILS1
inputDSSAT=INPUT_DSSAT
CSV=UTILS1/CsvOuts
PEST=PEST
PLANTP=PLANTP
VPATH= .:$(swat):$(smrt):$(MODFLOW):$(rt):$(plant):$(utils1):$(inputDSSAT):$(CSV):$(PEST):$(PLANTP)
EVENT = $(LIB.DIR)$(EVENT.DLL)
FC = gfortran
FCI=ifort
MODFS = modparm.f smrt_parm.f rt_modparm.f mf_rt_link.f mf_mach_mod.f90 mf_gwf2bas7_NWT.f mf_de47_NWT.f mf_sip7_NWT.f mf_gwf2riv7_NWT.f mf_modules.f90\
 mf_gwfsfrmodule_NWT.f mf_gwfuzfmodule_NWT.f mf_pcg7_NWT.f mf_nogmg.f mf_NWT1_module.f mf_gwf2bcf7.f mf_gwf2lpf7.f mf_gwf2huf7.f mf_gwf2upw1.f mf_gwf2sub7.f\
mf_gwf2drn7_NWT.f mf_obs2bas7.f mf_obs2drn7.f mf_obs2riv7.f mf_gwf2str7.f mf_obs2str7.f mf_gwf2ghb7_NWT.f mf_obs2ghb7.f mf_obs2chd7.f mf_gwf2swr7_NWT.f\
mf_gwf2wel7_NWT.f mf_gwf2evt7.f mf_gwf2rch7.f mf_NWT1_gmres.f90 mf_NWT1_xmdlib.f mf_NWT1_xmd.f mf_gwf2fhb7.f mf_gwf2res7.f mf_gwf2ibs7.f mf_gwf2chd7.f \
mf_gwf2hydmod7.f mf_gwf2hfb7_NWT.f mf_gwf2lak7_NWT.f mf_gwf2ets7.f mf_gwf2drt7.f mf_gwf2sfr7_NWT.f mf_gwf2gag7.f mf_gwf2mnw27_NWT.f mf_gwf2mnw2i7.f\
mf_gwf2uzf1_NWT.f mf_gwf2swt7.f mf_gwf2mnw17_NWT.f mf_lmt7_NWT.f mf_NWT1_ilupc_mod.f90\
OSDefsLINUX.for CSMVersion.for ModuleDefs.for OPHEAD.for csvlinklist.f90 csvoutput.f90 interface.f90


MODOBJ =modparm.o smrt_parm.o rt_modparm.o mf_rt_link.o mf_mach_mod.o mf_gwf2bas7_NWT.o mf_de47_NWT.o mf_sip7_NWT.o  mf_gwf2riv7_NWT.o mf_modules.o\
 mf_gwfsfrmodule_NWT.o mf_gwfuzfmodule_NWT.o mf_pcg7_NWT.o mf_nogmg.o mf_NWT1_module.o mf_gwf2bcf7.o  mf_gwf2lpf7.o mf_gwf2huf7.o mf_gwf2upw1.o mf_gwf2sub7.o\
mf_gwf2drn7_NWT.o mf_obs2bas7.o mf_obs2drn7.o mf_obs2riv7.o  mf_gwf2str7.o mf_obs2str7.o mf_gwf2ghb7_NWT.o mf_obs2ghb7.o mf_obs2chd7.o mf_gwf2swr7_NWT.o\
mf_gwf2wel7_NWT.o mf_gwf2evt7.o mf_gwf2rch7.o mf_NWT1_gmres.o mf_NWT1_xmdlib.o mf_NWT1_xmd.o mf_gwf2fhb7.o mf_gwf2res7.o mf_gwf2ibs7.o mf_gwf2chd7.o \
mf_gwf2hydmod7.o mf_gwf2hfb7_NWT.o mf_gwf2lak7_NWT.o mf_gwf2ets7.o mf_gwf2drt7.o mf_gwf2sfr7_NWT.o mf_gwf2gag7.o mf_gwf2mnw27_NWT.o mf_gwf2mnw2i7.o\
mf_gwf2uzf1_NWT.o mf_gwf2swt7.o mf_gwf2mnw17_NWT.o  mf_lmt7_NWT.o mf_NWT1_ilupc_mod.o\
OSDefsLINUX.o CSMVersion.o ModuleDefs.o OPHEAD.o csvlinklist.o csvoutput.o interface.o 
MODFS2 = smrt_parm.f mf_link.f
MODOBJ2 = $(pathsubst %.f,%.o, $(MODFS2))
#OBJ = $(patsubst %.f,%.o, $(wildcard *.f)) $(patsubst %.f90,%.o, $(wildcard *.f90)) $(patsubst %.f03,%.o, $(wildcard *.f03) $(pathsubst %.f,%.o,$(smrt)$(wildcard *.f)) )
OBJ =rt_openio.o smrt_modifySWATgw.o smrt_allocate.o rt_init.o rt_read.o smrt_init_rt3d.o smrt_read_drain2sub.o smrt_read_irrig.o smrt_read_river2grid.o smrt_read_dhru2hru.o smrt_read_dhru2grid.o smrt_read_grid2dhru.o mf_read.o rtsed_yangsand.o rtsed_Molinas_Wu.o rtsed_kodatie.o rtsed_bagnold.o smrt_init_mf.o smrt_grid2dhru2D.o smrt_dhru2hru.o smrt_grid2dhru3D.o smrt_conversion2swat.o smrt_dhru2grid2D.o rt_stress.o smrt_dhru2rtgrid3D.o smrt_hru2dhru.o rt_vst.o rt_gcg.o rt_ssm.o rt_adv.o rt_implicit.o rt_dsp.o rt_run.o rt_fmi.o smrt_conversion2rt3d.o smrt_rt3d_run.o mf_NWT1_solver.o smrt_units.o smrt_rt3d_stress.o smrt_well.o smrt_evt.o smrt_recharge.o smrt_mfRiver.o mf_run.o smrt_conversion2mf.o smrt_mf_run.o mf_gsol7.o\
 rt_rxns.o rt_rct.o mf_hufutl7.o rt_btn.o rt_close.o mf_MF_NWT.o mf_close.o mf_parutl7.o mf_utl7.o smrt_close.o smrt_read_link.o\
 smrt_main.o addh.o albedo.o allocate_parms.o alph.o anfert.o apex_day.o apply.o ascrv.o atri.o aunif.o autoirr.o bacteria.o biozone.o\
bmp_det_pond.o bmpinit.o bmp_ri_pond.o bmp_sand_filter.o bmp_sed_pond.o bmp_wet_pond.o buffer.o burnop.o canopyint.o caps.o carbon_new.o\
carbon_zhang2.o cfactor.o clgen.o clicon.o command.o conapply.o confert.o crackflow.o crackvol.o curno.o dailycn.o decay.o depstor.o\
 dormant.o drains.o dstn1.o ee.o eiusle.o enrsb.o estimate_ksat.o etact.o etpot.o expo.o fert.o filter.o filtw.o distrib_bmps.o\
finalbal.o gcycl.o getallo.o grass_wway.o graze.o grow.o gwmod_deep.o gwmod.o gw_no3.o gwnutr.o h2omgt_init.o harvestop.o harvkillop.o\
header.o headout.o hhnoqual.o hhwatqual.o hmeas.o hruaa.o hruallo.o hruday.o hrumon.o hrupond.o hrupondhr.o hruyr.o hydroinit.o icl.o bmpfixed.o \
impndaa.o impndday.o impnd_init.o impndmon.o impndyr.o irrigate.o irr_rch.o irr_res.o irrsub.o jdt.o killop.o lakeq.o latsed.o layersplit.o \
 lwqdef.o main.o ndenit.o newtillmix.o nfix.o rthr.o NCsed_leach.o \
nitvol.o nlch.o nminrl.o noqual.o npup.o nrain.o nup.o nuts.o openwth.o operatn.o orgncswat.o orgn.o origtile.o ovr_sed.o\
percmacro.o percmain.o percmicro.o pestlch.o pestw.o pesty.o pgen.o pgenhr.o pkq.o plantmod.o plantop.o\
pmeas.o pminrl2.o pminrl.o pond.o pondhr.o pothole.o print_hyd.o psed.o qman.o rchaa.o rchday.o rchinit.o rchmon.o rchuse.o rchyr.o\
readatmodep.o readbsn.o readchm.o readcnst.o readfcst.o readfert.o readfig.o readfile.o readgw.o readhru.o readinpt.o readlup.o readlwq.o\
readmgt.o readmon.o readops.o readpest.o readplant.o readpnd.o readres.o readrte.o readru.o readsdr.o readsepticbz.o readseptwq.o readsno.o\
readsol.o readsub.o readswq.o readtill.o readurban.o readwgn.o readwus.o readwwq.o readyr.o reccnst.o recday.o rechour.o recmon.o recyear.o\
regres.o resetlu.o res.o reshr.o resinit.o resnut.o rewind_init.o rhgen.o rootfr.o route.o routels.o routeunit.o routres.o rsedaa.o\
rseday.o rsedmon.o rsedyr.o rtbact.o rtday.o rteinit.o rthmusk.o rthpest.o rthsed.o  rtmusk.o rtout.o rtpest.o rtsed.o\
sat_excess.o saveconc.o save.o sched_mgt.o schedule_ops.o sim_initday.o sim_inityr.o simulate.o slrgen.o smeas.o snom.o soil_chem.o\
soil_phys.o soil_write.o solp.o solt.o std1.o std2.o std3.o stdaa.o storeinitial.o structure.o subaa.o subbasin.o subday.o submon.o\
substor.o sub_subbasin.o subwq.o subyr.o sumhyd.o sumv.o surface.o surfst_h2o.o surfstor.o surq_daycn.o surq_greenampt.o swbl.o sweep.o\
swu.o tair.o tgen.o theta.o tillfactor.o tmeas.o tran.o transfer.o tstr.o ttcoef.o ttcoef_wway.o urban.o urbanhr.o urb_bmp.o varinit.o\
vbl.o virtual.o volq.o washp.o watbal.o water_hru.o watqual2.o watqual.o wattable.o watuse.o weatgn.o wetlan.o wmeas.o wndgen.o writeaa.o\
writea.o writed.o writem.o xmon.o ysed.o zero0.o zero1.o zero2.o zeroini.o zero_urbn.o\
Info.o ERROR.o OPSUM.o OPVIEW.o OPHARV.o PlantNBal.o HRes_CGRO.o PODDET.o PODS.o NUPTAK.o INCOMP.o DEMAND.o PHENOL.o PHOTO.o IPPLNT.o READS.o UTILS.o DATES.o Warning.o\
OPPEST.o OpPlantP.o PPlantSubs.o P_Uptake.o P_IPPLNT.o LINDM.o\
ROOTDM.o VEGDM.o SEEDDM.o ASMDM.o PESTCP.o IPPROG.o IPPARM.o IPPEST.o P_Plant.o RootSoilVol.o P_CGRO.o PEST.o OPSTRESS.o CANOPY.o RStages.o Ipphenol.o SDCOMP.o\
FreshWt.o RESPIR.o MOBIL.o VEGGR.o SENES.o FREEZE.o ROOTS.o Opgrow.o CROPGRO.o

all: swat swatdll

swat: $(MODOBJ) $(OBJ)
	$(FC) $(FFLAGS) $(MODOBJ) $(OBJ) -o $(SWAT.OUT)
	$(CP) $(SWAT.OUT) $(BIN.DIR)
	$(CP) *.mod $(LIB.DIR)

swatdll: $(MODOBJ2) $(OBJ)
	$(FC) $(FFLAGS) $(MODOBJ2) $(OBJ) -shared -o $(SWAT.DLL)
	$(CP) $(SWAT.DLL) $(LIB.DIR)
	$(CP) *.mod $(LIB.DIR)

clean: 
#	$(MAKE) clean -C 
#	$(RM) *.o *.mod *.exe *.dll *.so $(SWAT.OUT)
	@rm -f *.o *.mod *.exe *.dll *.s0 $(SWAT.OUT)
.for.o:
	$(FC) $(FFLAGS) -c $<
.f90.o:
	$(FC) $(FFLAGS) -c $<
.f03.o:
	$(FC) $(FFLAGS) -c $<
.f.o:
	$(FC) $(FFLAGS) -c $<
.for.in.o:
	$(FC) $(FFLAGS) -c $<

$(LIB.DIR)$(EVENT.DIR): 
	$(MAKE) -C $(EVENT.DIR) 


